<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Uppy</title>
    <link href="https://releases.transloadit.com/uppy/v3.6.1/uppy.min.css" rel="stylesheet">
</head>
<body>
<div id="drag-drop-area"></div>

<script type="module">
    import {Uppy, Dashboard, Tus} from "https://releases.transloadit.com/uppy/v3.6.1/uppy.min.mjs"
    const serviceKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoic2VydmljZV9yb2xlIiwiaWF0IjoxNjEzNTMxOTg1LCJleHAiOjE5MjkxMDc5ODV9.th84OKK0Iz8QchDyXZRrojmKSEZ-OuitQm_5DvLiSIc'
    const authenticatedToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwic3ViIjoiMzE3ZWFkY2UtNjMxYS00NDI5LWEwYmItZjE5YTdhNTE3YjRhIiwiZW1haWwiOiJpbmlhbit0ZXN0MUBzdXBhYmFzZS5pbyIsImV4cCI6MTkzOTEwNzk4NSwiYXBwX21ldGFkYXRhIjp7InByb3ZpZGVyIjoiZW1haWwifSwidXNlcl9tZXRhZGF0YSI6e30sInJvbGUiOiJhdXRoZW50aWNhdGVkIn0.E-x3oYcHIjFCdUO1M3wKDl1Ln32mik0xdHT2PjrvN70'
    const anonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlhdCI6MTYxMzUzMTk4NSwiZXhwIjoxOTI5MTA3OTg1fQ.mqfi__KnQB4v6PkIjkhzfwWrYyF94MEbSC6LnuvVniE'
    const token = serviceKey

    const bucketName = 'bucket25'

    var uppy = new Uppy()
        .use(Dashboard, {
            inline: true,
            limit: 10,
            target: '#drag-drop-area',
            showProgressDetails: true,
        })
        .use(Tus, {
            endpoint: 'http://localhost:5000/multi-part/',
            removeFingerprintOnSuccess: true,
            headers: {
                authorization: `Bearer ${token}`,
                'x-upsert': 'true',
            },
            uploadDataDuringCreation: true,
            chunkSize: 6 * 1024 * 1024,
            allowedMetaFields: ['bucketName', 'objectName', 'contentType'],
            onError: function(error) {
                console.log("Failed because: " + error)
            },
        })

    uppy.on('file-added', (file) => {
        const supabaseMetadata = {
            bucketName: bucketName,
            objectName: `finished/no-metadata`,
            contentType: 'image/png',
        }

        file.meta = {
            ...file.meta,
            ...supabaseMetadata,
        }

        console.log('fdfjdjdj', file)
    })

    uppy.on('complete', (result) => {
        console.log('Upload complete! Weâ€™ve uploaded these files:', result.successful)
        // setTimeout(() => {
        //     const items = uppy.getFiles().map((file) => {
        //         uppy.removeFile(file.id)
        //     })
        // }, 4 * 1000)

    })
</script>
</body>
</html>